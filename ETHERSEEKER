<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAPA ETERNIVERSE v9.0</title>
  <meta name="description" content="Synchronizacja w chmurze ‚Äì Uniwersum ≈ºyje na wszystkich urzƒÖdzeniach."/>
  <meta name="theme-color" content="#D9A441"/>
 
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      --teal: #28d4c6;
      --green: #10b981;
      --orange: #f59e0b;
      --purple: #8b5cf6;
    }
    
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at 20% 80%, #667eea 0%, #764ba2 100%);
      color: white;
      overflow: hidden;
    }

    .wrap { 
      position: relative; 
      width: 100vw; 
      height: 100vh; 
    }

    .controls {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 12px 20px;
      border-radius: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    .btn:hover { 
      background: rgba(255,255,255,0.25);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }

    .cloud-status {
      position: fixed;
      top: 70px;
      right: 20px;
      background: rgba(40,211,198,0.15);
      color: var(--teal);
      padding: 10px 16px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 700;
      border: 1px solid var(--teal);
      z-index: 900;
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 160px;
    }
    .cloud-status.offline { 
      background: rgba(255,177,75,0.2); 
      color: var(--orange); 
      border-color: var(--orange); 
    }
    .cloud-status.syncing::after { 
      content: ' ‚Üª'; 
      animation: spin 1s linear infinite; 
    }
    @keyframes spin { 
      from { transform: rotate(0deg); } 
      to { transform: rotate(360deg); } 
    }
    .cloud-dot {
      width: 10px; height: 10px; 
      border-radius: 50%; 
      background: var(--green); 
      animation: pulse-cloud 2s infinite;
    }
    .cloud-dot.offline { 
      background: var(--orange); 
      animation: none; 
    }
    @keyframes pulse-cloud { 
      0%,100% { opacity: 0.6; } 
      50% { opacity: 1; } 
    }

    #mapCanvas {
      width: 100vw;
      height: 100vh;
      cursor: grab;
    }
    #mapCanvas:active { cursor: grabbing; }

    .save-indicator {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--green);
      color: white;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }
    .save-indicator.show { opacity: 1; }
  </style>
</head>
<body>

<div class="cloud-status" id="cloudStatus">
  <div class="cloud-dot"></div>
  <span id="cloudText">Inicjalizacja...</span>
</div>

<div class="save-indicator" id="saveIndicator">Zapisano</div>

<div class="wrap">
  <div class="controls">
    <button class="btn" id="forceSync">‚òÅ Synchronizuj</button>
    <button class="btn" id="newStar">‚≠ê Nowa gwiazda</button>
    <button class="btn" id="clearMap">üóë Wyczy≈õƒá</button>
  </div>
  
  <canvas id="mapCanvas"></canvas>
</div>

<script>
  // ===== KONFIGURACJA FIREBASE - ZMIE≈É NA SWOJE DANE =====
  const firebaseConfig = {
    apiKey: "AIzaSyDxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx", // Z Firebase Console
    authDomain: "eterniverse-xxxxx.firebaseapp.com",
    databaseURL: "https://eterniverse-xxxxx-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "eterniverse-xxxxx",
    storageBucket: "eterniverse-xxxxx.appspot.com",
    messagingSenderId: "123456789",
    appId: "1:123456789:web:abcdef123456"
  };

  // Inicjalizacja Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();
  
  // Referencje do bazy
  const universeRef = db.ref('eterniverse/universe');
  const userRef = db.ref('eterniverse/users');

  // Stan aplikacji
  let mapData = {
    stars: [],
    timestamp: Date.now(),
    version: 9.0
  };
  let isOnline = navigator.onLine;
  let syncPending = false;
  let lastCloudSync = parseInt(localStorage.getItem('last_cloud_sync') || '0');
  let currentUser = null;

  // Canvas setup
  const canvas = document.getElementById('mapCanvas');
  const ctx = canvas.getContext('2d');
  let scale = 1, offsetX = 0, offsetY = 0;
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  // ===== STATUS CHMURY =====
  const updateCloudStatus = (text, status = 'connecting') => {
    const el = document.getElementById('cloudText');
    const dot = document.querySelector('.cloud-dot');
    const container = document.getElementById('cloudStatus');
    
    el.textContent = text;
    container.className = `cloud-status ${status}`;
    dot.className = `cloud-dot ${status === 'offline' ? 'offline' : ''}`;
    
    if (status === 'syncing') container.classList.add('syncing');
    else container.classList.remove('syncing');
  };

  const showSaveIndicator = () => {
    const indicator = document.getElementById('saveIndicator');
    indicator.classList.add('show');
    setTimeout(() => indicator.classList.remove('show'), 2000);
  };

  // ===== OBS≈ÅUGA PO≈ÅƒÑCZENIA =====
  window.addEventListener('online', () => {
    isOnline = true;
    updateCloudStatus('Online', 'online');
    triggerSync();
  });

  window.addEventListener('offline', () => {
    isOnline = false;
    updateCloudStatus('Offline ‚Äì tryb lokalny', 'offline');
  });

  // ===== SYNCHRONIZACJA Z CHMURƒÑ =====
  const pushToCloud = async () => {
    if (!isOnline || !currentUser) return;
    
    updateCloudStatus('Wysy≈Çanie...', 'syncing');
    
    try {
      const data = {
        map_data: mapData,
        meta: {
          version: 9.0,
          last_updated: firebase.database.ServerValue.TIMESTAMP,
          device: navigator.userAgent.substring(0, 50),
          userId: currentUser.uid
        }
      };
      
      await universeRef.set(data);
      lastCloudSync = Date.now();
      localStorage.setItem('last_cloud_sync', lastCloudSync.toString());
      updateCloudStatus('Zsynchronizowano', 'online');
      syncPending = false;
    } catch (err) {
      console.error('B≈ÇƒÖd synchronizacji:', err);
      updateCloudStatus('B≈ÇƒÖd synchronizacji', 'error');
    }
  };

  const pullFromCloud = async () => {
    try {
      const snapshot = await universeRef.once('value');
      if (snapshot.exists()) {
        const data = snapshot.val();
        const remoteTimestamp = data.meta?.last_updated || 0;
        
        // RozwiƒÖzywanie konflikt√≥w - nowsza wersja wygrywa
        if (remoteTimestamp > lastCloudSync) {
          mapData = data.map_data;
          lastCloudSync = remoteTimestamp;
          localStorage.setItem('last_cloud_sync', lastCloudSync.toString());
          
          renderMap();
          updateCloudStatus('Zsynchronizowano z chmury', 'online');
          showSaveIndicator();
        }
      }
    } catch (err) {
      console.error('B≈ÇƒÖd pobierania:', err);
    }
  };

  const triggerSync = async () => {
    if (syncPending || !isOnline) return;
    syncPending = true;
    
    // Najpierw pull, potem push (last-writer-wins)
    await pullFromCloud();
    await pushToCloud();
  };

  // ===== REALTIME LISTENER =====
  universeRef.on('value', async (snapshot) => {
    if (!snapshot.exists() || !isOnline) return;
    
    const data = snapshot.val();
    const remoteTimestamp = data.meta?.last_updated || 0;
    
    if (remoteTimestamp > lastCloudSync) {
      mapData = data.map_data;
      lastCloudSync = remoteTimestamp;
      localStorage.setItem('last_cloud_sync', lastCloudSync.toString());
      
      renderMap();
      updateCloudStatus('Aktualizacja z chmury', 'online');
      showSaveIndicator();
    }
  });

  // ===== ZAPIS LOKALNY =====
  const saveLocal = async () => {
    localStorage.setItem('eterniverse_map_v9', JSON.stringify(mapData));
    showSaveIndicator();
    if (isOnline) triggerSync();
  };

  // ===== RYSOWANIE MAPY =====
  const renderMap = () => {
    ctx.fillStyle = '#0a0a1a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.save();
    ctx.translate(offsetX, offsetY);
    ctx.scale(scale, scale);
    
    // Gwiazdy
    mapData.stars.forEach(star => {
      ctx.fillStyle = star.color || '#ffffff';
      ctx.beginPath();
      ctx.arc(star.x, star.y, star.size || 2, 0, Math.PI * 2);
      ctx.fill();
    });
    
    ctx.restore();
  };

  // ===== INTERAKCJE =====
  let isDragging = false;
  let lastX, lastY;

  canvas.addEventListener('mousedown', (e) => {
    isDragging = true;
    lastX = e.clientX;
    lastY = e.clientY;
    canvas.style.cursor = 'grabbing';
  });

  canvas.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    
    const deltaX = e.clientX - lastX;
    const deltaY = e.clientY - lastY;
    
    offsetX += deltaX / scale;
    offsetY += deltaY / scale;
    
    lastX = e.clientX;
    lastY = e.clientY;
    renderMap();
  });

  canvas.addEventListener('mouseup', () => {
    isDragging = false;
    canvas.style.cursor = 'grab';
  });

  canvas.addEventListener('wheel', (e) => {
    e.preventDefault();
    const zoom = e.deltaY > 0 ? 0.9 : 1.1;
    scale *= zoom;
    scale = Math.max(0.1, Math.min(scale, 5));
    renderMap();
  });

  canvas.addEventListener('click', (e) => {
    if (isDragging) return;
    
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left - offsetX) / scale;
    const y = (e.clientY - rect.top - offsetY) / scale;
    
    // Dodaj nowƒÖ gwiazdƒô
    mapData.stars.push({
      x, y,
      size: Math.random() * 3 + 1,
      color: `hsl(${Math.random() * 60 + 200}, 70%, ${Math.random() * 40 + 50}%)`
    });
    
    mapData.timestamp = Date.now();
    saveLocal();
    renderMap();
  });

  // ===== PRZYCISKI =====
  document.getElementById('newStar').addEventListener('click', () => {
    // Symulacja losowej gwiazdy
    mapData.stars.push({
      x: Math.random() * 2000 - 1000,
      y: Math.random() * 2000 - 1000,
      size: Math.random() * 4 + 1,
      color: `hsl(${Math.random() * 360}, 70%, 60%)`
    });
    mapData.timestamp = Date.now();
    saveLocal();
    renderMap();
  });

  document.getElementById('clearMap').addEventListener('click', () => {
    if (confirm('Wyczy≈õciƒá mapƒô?')) {
      mapData = { stars: [], timestamp: Date.now(), version: 9.0 };
      saveLocal();
      renderMap();
    }
  });

  document.getElementById('forceSync').addEventListener('click', async () => {
    await pullFromCloud();
    await pushToCloud();
  });

  // ===== INICJALIZACJA =====
  window.addEventListener('DOMContentLoaded', async () => {
    // ≈Åaduj lokalne dane
    const localData = localStorage.getItem('eterniverse_map_v9');
    if (localData) {
      mapData = JSON.parse(localData);
    }
    
    // Anonimowe logowanie do Firebase
    try {
      await auth.signInAnonymously();
      auth.onAuthStateChanged((user) => {
        currentUser = user;
        if (user && isOnline) {
          triggerSync();
        }
      });
    } catch (err) {
      console.error('B≈ÇƒÖd autentykacji:', err);
    }

    // Ustaw status chmury
    if (isOnline) {
      updateCloudStatus('Online', 'online');
      await pullFromCloud();
    } else {
      updateCloudStatus('Offline ‚Äì tryb lokalny', 'offline');
    }

    renderMap();
    canvas.style.cursor = 'grab';
  });

  // Resize handler
  window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    renderMap();
  });
</script>
</body>
</html>