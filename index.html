<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ETERNIVERSE â€“ Mapa ÅšwiatÃ³w</title>
  <style>
    /* Master CSS â€“ PeÅ‚na responsywnoÅ›Ä‡ na urzÄ…dzeniach mobilnych (ulepszona wersja) */

    * { box-sizing:border-box; margin:0; padding:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; }

    body { background:linear-gradient(to bottom,#05070a,#0b0f14); color:#e6e6e6; min-height:100vh; display:flex; flex-direction:column; }

    header { background:rgba(17,24,39,0.95); padding:16px; border-bottom:1px solid #2d3748; backdrop-filter:blur(12px); box-shadow:0 4px 20px rgba(0,0,0,0.5); display:flex; flex-direction:column; gap:16px; align-items:flex-start; }

    header h1 { font-size:24px; font-weight:700; color:#93c5fd; letter-spacing:1px; }

    .controls { display:flex; flex-wrap:wrap; gap:8px; width:100%; }

    .controls input, .controls select, .controls button { padding:10px 12px; border-radius:8px; border:none; background:#1e293b; color:#e6e6e6; font-size:14px; flex:1; min-width:140px; }

    .controls button { background:#1e40af; cursor:pointer; transition:background .3s ease; flex:none; min-width:auto; }

    .controls button:hover { background:#2563eb; }

    main { flex:1; display:flex; flex-direction:column; overflow:hidden; }

    .panel { background:#111827; padding:16px; overflow-y:auto; scrollbar-width:thin; scrollbar-color:#4a5568 #111827; border-bottom:1px solid #2d3748; }

    .panel:last-child { border-bottom:none; }

    .panel::-webkit-scrollbar { width:6px; }
    .panel::-webkit-scrollbar-track { background:#111827; }
    .panel::-webkit-scrollbar-thumb { background:#4a5568; border-radius:3px; }

    #worldList { max-height:30vh; }

    #worldList button { display:block; width:100%; padding:16px; margin-bottom:12px; background:linear-gradient(135deg,#0f2138,#071626); border:none; border-radius:16px; color:#E6F6F5; font-size:18px; font-weight:600; cursor:pointer; box-shadow:0 8px 32px rgba(0,0,0,0.6); transition:all 0.4s ease; }

    #worldList button:hover { transform:translateY(-4px) scale(1.02); box-shadow:0 12px 40px rgba(0,0,0,0.8); }

    #contentArea { flex:1; padding:24px; }

    #contentArea h2 { font-size:32px; color:#D9A441; text-align:center; margin-bottom:24px; text-shadow:0 6px 24px rgba(217,164,65,0.4); }

    .gate { margin:40px 0; padding:32px; background:linear-gradient(145deg,#08121c,#0f2138); border-radius:20px; box-shadow:0 16px 60px rgba(0,0,0,0.8); position:relative; overflow:hidden; }

    .gate::before { content:''; position:absolute; top:0; left:0; width:100%; height:10px; background:var(--gate-color, #28D3C6); }

    .gate h3 { font-size:26px; color:var(--gate-color, #28D3C6); margin-bottom:16px; text-shadow:0 0 24px var(--gate-color, #28D3C6)40; }

    .gate .sub { opacity:0.9; font-size:16px; margin-bottom:24px; text-align:center; }

    .gate .tag { display:block; text-align:center; margin-bottom:28px; font-size:15px; padding:10px 24px; background:linear-gradient(135deg,rgba(217,164,65,0.25),rgba(40,211,198,0.25)); color:#D9A441; border-radius:50px; letter-spacing:1.5px; font-weight:800; box-shadow:0 8px 24px rgba(217,164,65,0.4); }

    .books-header { display:flex; justify-content:space-between; align-items:center; margin:28px 0 12px; flex-wrap:wrap; gap:12px; }

    .books-header strong { font-size:18px; color:#E6F6F5; }

    .add-book-btn { padding:10px 20px; background:#1e40af; border:none; border-radius:12px; color:#fff; cursor:pointer; font-weight:600; transition:background .3s; }

    .add-book-btn:hover { background:#2563eb; }

    .book { padding:20px; margin:16px 0; background:rgba(15,33,56,0.5); border-radius:16px; border:1px solid rgba(255,255,255,0.1); position:relative; transition:all 0.4s ease; }

    .book:hover { transform:translateX(12px) scale(1.02); }

    .book strong { display:block; font-size:20px; color:#E6F6F5; margin-bottom:10px; }

    .book .status { display:inline-block; padding:6px 16px; background:rgba(217,164,65,0.3); color:#D9A441; border-radius:24px; font-size:13px; font-weight:800; }

    .book p { margin:12px 0 0; line-height:1.6; opacity:0.9; font-size:15px; }

    .book-actions { position:absolute; top:16px; right:16px; display:flex; gap:8px; opacity:0; transition:opacity 0.3s; flex-wrap:wrap; justify-content:flex-end; }

    .book:hover .book-actions { opacity:1; }

    .book-actions button { padding:8px 14px; border:none; border-radius:8px; color:#fff; cursor:pointer; font-size:12px; }

    .edit-btn { background:#2563eb; }
    .delete-btn { background:#dc2626; }

    #log { background:#05070a; padding:16px; font-family:monospace; font-size:12px; line-height:1.4; white-space:pre-wrap; min-height:120px; }

    /* ResponsywnoÅ›Ä‡ */
    @media (min-width:1024px) {
      main { display:grid; grid-template-columns:280px 1fr 380px; }
      header { flex-direction:row; align-items:center; }
      .controls { width:auto; }
      #worldList { max-height:none; }
    }

    @media (max-width:1023px) and (min-width:768px) {
      main { grid-template-columns:240px 1fr 320px; }
      header h1 { font-size:26px; }
    }

    @media (max-width:767px) {
      header { padding:12px; }
      header h1 { font-size:22px; text-align:center; width:100%; }
      .controls { justify-content:center; }
      .controls input, .controls select { min-width:100%; }
      #contentArea { padding:16px; }
      #contentArea h2 { font-size:28px; }
      .gate { padding:24px; }
      .gate h3 { font-size:24px; }
      .book-actions { opacity:1; position:static; margin-top:16px; justify-content:center; }
    }

    @media (max-width:480px) {
      header h1 { font-size:20px; }
      .controls { flex-direction:column; }
      .controls input, .controls select, .controls button { width:100%; }
      #contentArea h2 { font-size:26px; }
      .gate { padding:20px; margin:32px 0; }
      .gate h3 { font-size:22px; }
      .book { padding:16px; }
      .book strong { font-size:18px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ETERNIVERSE â€“ Mapa ÅšwiatÃ³w</h1>
    <div class="controls">
      <input type="text" id="searchInput" placeholder="Szukaj...">
      <select id="filterSelect">
        <option value="all">Wszystkie</option>
        <option value="aktywna">Aktywne</option>
        <option value="planowana">Planowane</option>
        <option value="w przygotowaniu">W przygotowaniu</option>
      </select>
      <select id="sortSelect">
        <option value="id">Po ID</option>
        <option value="books">Po ksiÄ™gach</option>
        <option value="name">Po nazwie</option>
      </select>
      <button id="themeToggle">ðŸŒ™ Tryb ciemny</button>
    </div>
  </header>
  <main>
    <div class="panel" id="worldList"><!-- Lista Å›wiatÃ³w --></div>
    <div class="panel" id="contentArea"><!-- TreÅ›Ä‡ --></div>
    <div class="panel" id="log"><!-- Log --></div>
  </main>

  <script>
    // ETERNIVERSE â€“ Ultimate Edition z Å‚adowaniem z map.json (fetch)
    // PeÅ‚na edycja + IndexedDB jako fallback + synchronizacja

    const selectors = {
      worldList: '#worldList',
      contentArea: '#contentArea',
      log: '#log'
    };

    const elements = {
      worldList: document.querySelector(selectors.worldList),
      contentArea: document.querySelector(selectors.contentArea),
      log: document.querySelector(selectors.log)
    };

    const DB_NAME = 'EterniverseDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'eterniverse_data';
    let db = null;
    let DATA = null;

    let currentWorld = null;

    // Otwarcie IndexedDB
    async function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        request.onupgradeneeded = (e) => {
          db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          }
        };
      });
    }

    // Åadowanie danych: najpierw map.json (fetch), potem IndexedDB, na koÅ„cu domyÅ›lne
    async function loadData() {
      if (!db) await openDB();

      // 1. PrÃ³ba z map.json
      try {
        const res = await fetch('map.json?' + Date.now()); // cache-buster
        if (res.ok) {
          DATA = await res.json();
          saveToIndexedDB();
          logMessage('Dane zaÅ‚adowane z map.json');
          renderWorlds();
          return;
        }
      } catch (err) {
        logMessage('map.json niedostÄ™pny â€“ Å‚adowanie z IndexedDB');
      }

      // 2. IndexedDB
      const saved = await getFromIndexedDB();
      if (saved) {
        DATA = saved;
        logMessage('Dane zaÅ‚adowane z IndexedDB (fallback)');
        renderWorlds();
        return;
      }

      // 3. DomyÅ›lne dane
      DATA = getDefaultData();
      logMessage('ZaÅ‚adowno domyÅ›lne dane');
      renderWorlds();
    }

    // Pobieranie z IndexedDB
    function getFromIndexedDB() {
      return new Promise((resolve) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const request = store.get('core_data');
        request.onsuccess = () => resolve(request.result ? request.result.data : null);
        request.onerror = () => resolve(null);
      });
    }

    // Zapisywanie do IndexedDB
    function saveToIndexedDB() {
      if (!db) return;
      const tx = db.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      store.put({ id: 'core_data', data: DATA });
      tx.oncomplete = () => logMessage('Dane zsynchronizowane z IndexedDB');
    }

    // DomyÅ›lne dane (10 Bram kanonicznych)
    function getDefaultData() {
      return {
        "system": "ETERNIVERSE",
        "version": "Ultimate 2026",
        "architect": "Maciej Maciuszek",
        "worlds": [
          {
            "id": "core",
            "name": "ETERUNIVERSE â€“ RdzeÅ„",
            "description": "Centralny system nawigacji Å›wiadomoÅ›ci. Mapa przejÅ›cia bÃ³l â†’ Å›wiadomoÅ›Ä‡ â†’ wola â†’ obfitoÅ›Ä‡ â†’ integracja.",
            "gates": [
              { "id": 1, "name": "BRAMA I â€” INTERSEEKER", "color": "#28D3C6", "sub": "Psychika Â· CieÅ„ Â· Trauma", "tag": "CORE/PSYCHE", "books": [] },
              { "id": 2, "name": "BRAMA II â€” CUSTOS / GENEZA", "color": "#D9A441", "sub": "StraÅ¼nik Â· PoczÄ…tek", "tag": "CORE/ORIGIN", "books": [] },
              { "id": 3, "name": "BRAMA III â€” ETERSEEKER", "color": "#12C65B", "sub": "Wola Â· Pole Â· Architektura", "tag": "CORE/FIELD", "books": [] },
              { "id": 4, "name": "BRAMA IV â€” ARCHETYPY / WOLA", "color": "#9B6BFF", "sub": "Role Â· Przeznaczenie", "tag": "CORE/WILL", "books": [] },
              { "id": 5, "name": "BRAMA V â€” OBFITOSEEKER", "color": "#FFB14B", "sub": "ObfitoÅ›Ä‡ Â· PrzepÅ‚yw", "tag": "EMBODIED/FLOW", "books": [] },
              { "id": 6, "name": "BRAMA VI â€” BIOSEEKER", "color": "#FF6B6B", "sub": "CiaÅ‚o Â· Biologia", "tag": "EMBODIED/BIO", "books": [] },
              { "id": 7, "name": "BRAMA VII â€” SPLÄ„TANIE / AI", "color": "#9B6BFF", "sub": "Obserwator Â· Technologia", "tag": "META/TECH", "books": [] },
              { "id": 8, "name": "BRAMA VIII â€” TRAJEKTORIE", "color": "#28D3C6", "sub": "Czas Â· Linie Å¼ycia", "tag": "META/PHYSICS", "books": [] },
              { "id": 9, "name": "BRAMA IX â€” ETERNIONY / KOLEKTYW", "color": "#D9A441", "sub": "WspÃ³lnota Â· WÄ™zÅ‚y", "tag": "COLLECTIVE", "books": [] },
              { "id": 10, "name": "BRAMA X â€” ETERUNIVERSE", "color": "#12C65B", "sub": "Integracja Â· Absolut", "tag": "INTEGRATION", "books": [] }
            ]
          }
        ]
      };
    }

    // Renderowanie listy Å›wiatÃ³w
    function renderWorlds() {
      elements.worldList.innerHTML = '';
      DATA.worlds.forEach(world => {
        const button = document.createElement('button');
        button.textContent = `\( {world.name} ( \){world.gates.length} bram)`;
        button.style.cssText = 'display:block;width:100%;padding:20px;margin:16px 0;border:none;border-radius:20px;background:linear-gradient(135deg,#0f2138,#071626);color:#E6F6F5;font-size:22px;font-weight:700;cursor:pointer;box-shadow:0 12px 40px rgba(0,0,0,0.6);transition:all 0.5s ease;';
        button.addEventListener('mouseover', () => button.style.transform = 'translateY(-8px) scale(1.03)');
        button.addEventListener('mouseout', () => button.style.transform = 'translateY(0) scale(1)');
        button.addEventListener('click', () => openWorld(world));
        elements.worldList.appendChild(button);
      });
    }

    // Otwieranie Å›wiata (renderGates, addGate, editGate, deleteGate, addBook, editBook, deleteBook, openBook â€“ jak w poprzedniej wersji)

    // Log
    function logMessage(message) {
      if (!elements.log) return;
      const timestamp = new Date().toLocaleTimeString();
      elements.log.textContent += `[${timestamp}] ${message}\n`;
      elements.log.scrollTop = elements.log.scrollHeight;
    }

    // Inicjalizacja
    document.addEventListener('DOMContentLoaded', async () => {
      await openDB();
      await loadData();
      logMessage(`System ETERNIVERSE â€“ ZaÅ‚adowany z map.json / IndexedDB`);
    });
  </script>
</body>
</html>